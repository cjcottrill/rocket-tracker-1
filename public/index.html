<!-- Hero Section -->
<div class="hero">
    <h1>üöÄ Chris The Rocket Guy</h1>
    <p class="tagline">Florida Space Coast Launch Tracker</p>
    
    <div class="hero-links">
        <a href="https://www.facebook.com/people/LaunchInsight/61584464880089/" target="_blank" rel="noopener noreferrer" class="hero-link facebook">
            <span class="hero-link-icon">üìò</span>
            LaunchInsight on Facebook
        </a>
    </div>

    <div class="next-launch-banner" id="next-launch-banner" style="display: none;">
        <div class="next-launch-label">Next Launch</div>
        <div class="next-launch-name" id="next-launch-name"></div>
        <div class="countdown" id="countdown"></div>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <div class="section-header">
        <h2>Upcoming Launches</h2>
        <span class="launch-count" id="launch-count"></span>
    </div>

    <div id="launches-container">
        <div class="loading">
            <div class="spinner"></div>
            <div class="loading-text">Fetching launch data...</div>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="footer">
    <div class="footer-links">
        <a href="https://www.facebook.com/people/LaunchInsight/61584464880089/" target="_blank" rel="noopener noreferrer" class="footer-link">
            üìò LaunchInsight on Facebook
        </a>
    </div>
    <p>Data from <a href="https://thespacedevs.com" target="_blank" rel="noopener noreferrer">The Space Devs</a> ‚Ä¢ Built by Chris The Rocket Guy</p>
</div>

<script>
    // ‚îÄ‚îÄ Timezone helpers ‚îÄ‚îÄ
    function getFloridaTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString('en-US', {
            timeZone: 'America/New_York',
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
    }

    function getFloridaTzAbbr(dateStr) {
        const date = new Date(dateStr);
        const parts = date.toLocaleTimeString('en-US', {
            timeZone: 'America/New_York',
            timeZoneName: 'short'
        }).split(' ');
        return parts[parts.length - 1]; // "EST" or "EDT"
    }

    function getUserTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true,
            timeZoneName: 'short'
        });
    }

    function isUserInFloridaTimezone(dateStr) {
        const date = new Date(dateStr);
        const floridaOffset = getTimezoneOffset(date, 'America/New_York');
        const userOffset = date.getTimezoneOffset() * -1;
        return floridaOffset === userOffset;
    }

    function getTimezoneOffset(date, tz) {
        const utcStr = date.toLocaleString('en-US', { timeZone: 'UTC' });
        const tzStr = date.toLocaleString('en-US', { timeZone: tz });
        const utcDate = new Date(utcStr);
        const tzDate = new Date(tzStr);
        return (tzDate - utcDate) / (1000 * 60);
    }

    // ‚îÄ‚îÄ Status badge helper ‚îÄ‚îÄ
    function getStatusBadge(status) {
        if (!status) return '';
        const abbrev = status.abbrev || '';
        let cls = 'status-tbd';
        if (abbrev === 'Go') cls = 'status-go';
        else if (abbrev === 'TBC') cls = 'status-tbc';
        else if (abbrev === 'Hold') cls = 'status-hold';
        return `<span class="status-badge ${cls}">${abbrev || 'TBD'}</span>`;
    }

    // ‚îÄ‚îÄ Webcast link helpers ‚îÄ‚îÄ
    function categorizeWebcastLink(vidUrl) {
        const url = (vidUrl.url || '').toLowerCase();
        const title = (vidUrl.title || '').toLowerCase();
        const source = (vidUrl.source || '').toLowerCase();

        // NASASpaceflight
        if (url.includes('nasaspaceflight') || title.includes('nasaspaceflight') || source.includes('nasaspaceflight')) {
            return { type: 'nsf', label: 'NASASpaceflight', priority: 1 };
        }

        // Spaceflight Now
        if (url.includes('spaceflightnow') || title.includes('spaceflight now') || source.includes('spaceflight now')) {
            return { type: 'sfn', label: 'Spaceflight Now', priority: 2 };
        }

        // YouTube (generic)
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            // Try to get a meaningful name
            const label = vidUrl.title || source || 'YouTube Stream';
            return { type: 'youtube', label: label, priority: 3 };
        }

        // Other
        const label = vidUrl.title || vidUrl.source || 'Webcast';
        return { type: 'other', label: label, priority: 4 };
    }

    function renderWebcastLinks(launch) {
        const vidURLs = launch.vidURLs || [];
        const isLive = launch.webcast_live;

        if (vidURLs.length === 0 && !isLive) return '';

        let categorized = vidURLs.map(v => ({
            ...categorizeWebcastLink(v),
            url: v.url
        }));

        // Sort: NSF first, then SFN, then YouTube, then others
        categorized.sort((a, b) => a.priority - b.priority);

        let html = '<div class="webcast-section">';
        html += '<div class="webcast-label">Watch</div>';
        html += '<div class="webcast-links">';

        if (isLive) {
            html += '<span class="webcast-live-indicator"><span class="webcast-live-dot"></span> LIVE NOW</span>';
        }

        categorized.forEach(link => {
            let icon = 'üì∫';
            if (link.type === 'youtube') icon = '‚ñ∂Ô∏è';
            if (link.type === 'nsf') icon = 'üöÄ';
            if (link.type === 'sfn') icon = 'üõ∞Ô∏è';

            html += `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="webcast-link ${link.type}">
                <span class="webcast-link-icon">${icon}</span>
                ${link.label}
            </a>`;
        });

        html += '</div></div>';
        return html;
    }

    // ‚îÄ‚îÄ Countdown timer ‚îÄ‚îÄ
    let countdownInterval;
    let nextLaunchNet;

    function updateCountdown() {
        if (!nextLaunchNet) return;
        const now = new Date();
        const launch = new Date(nextLaunchNet);
        const diff = launch - now;

        if (diff <= 0) {
            document.getElementById('countdown').textContent = 'LIFTOFF!';
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        let parts = [];
        if (days > 0) parts.push(`${days}d`);
        parts.push(`${hours}h ${minutes}m ${seconds}s`);

        document.getElementById('countdown').textContent = 'T- ' + parts.join(' ');
    }

    // ‚îÄ‚îÄ Render launches ‚îÄ‚îÄ
    function renderLaunches(launches) {
        const container = document.getElementById('launches-container');

        if (!launches || launches.length === 0) {
            container.innerHTML = `
                <div class="no-launches">
                    <div class="no-launches-icon">üå¥</div>
                    <p>No launches scheduled in the next 14 days.</p>
                    <p style="margin-top: 0.5rem; font-size: 0.8rem;">Check back soon!</p>
                </div>`;
            return;
        }

        // Update count
        document.getElementById('launch-count').textContent = `${launches.length} launch${launches.length !== 1 ? 'es' : ''}`;

        // Set up hero countdown for first launch
        const firstLaunch = launches[0];
        const statusAbbrev = firstLaunch.status?.abbrev || '';

        document.getElementById('next-launch-banner').style.display = 'block';
        document.getElementById('next-launch-name').textContent = firstLaunch.name;

        if (statusAbbrev === 'TBD') {
            document.getElementById('countdown').innerHTML = '<span class="countdown-tbd">Date/Time TBD</span>';
        } else {
            nextLaunchNet = firstLaunch.net;
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // Build launch cards
        let html = '';
        launches.forEach(launch => {
            const provider = launch.launch_service_provider?.name || 'Unknown Provider';
            const rocketName = launch.rocket?.configuration?.full_name || launch.rocket?.configuration?.name || 'Unknown Rocket';
            const missionType = launch.mission?.type || '‚Äî';
            const orbit = launch.mission?.orbit?.name || '‚Äî';
            const pad = launch.pad?.name || '‚Äî';
            const missionDesc = launch.mission?.description || '';
            const floridaTime = getFloridaTime(launch.net);
            const floridaTz = getFloridaTzAbbr(launch.net);
            const statusBadge = getStatusBadge(launch.status);
            const isTimeTBD = (launch.status?.abbrev === 'TBD');
            const webcastHtml = renderWebcastLinks(launch);

            let timeHtml = '';
            if (isTimeTBD) {
                const dateOnly = new Date(launch.net).toLocaleDateString('en-US', {
                    timeZone: 'America/New_York',
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                timeHtml = `
                    <div class="florida-time">${dateOnly} (Time TBD)</div>
                    <div class="florida-label">Florida Time</div>`;
            } else {
                timeHtml = `
                    <div class="florida-time">${floridaTime} ${floridaTz}</div>
                    <div class="florida-label">Florida Time</div>`;

                if (!isUserInFloridaTimezone(launch.net)) {
                    const userTime = getUserTime(launch.net);
                    timeHtml += `<div class="user-time">Your time: ${userTime}</div>`;
                }
            }

            html += `
                <div class="launch-card">
                    <div class="launch-card-header">
                        <div>
                            <div class="launch-provider">${provider}</div>
                            <div class="launch-name">${launch.name}</div>
                        </div>
                        ${statusBadge}
                    </div>

                    <div class="launch-details">
                        <div class="detail-item">
                            <span class="detail-label">Rocket</span>
                            <span class="detail-value">${rocketName}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Pad</span>
                            <span class="detail-value">${pad}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Mission Type</span>
                            <span class="detail-value">${missionType}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Orbit</span>
                            <span class="detail-value">${orbit}</span>
                        </div>
                    </div>

                    <div class="launch-time-section">
                        ${timeHtml}
                    </div>

                    ${webcastHtml}

                    ${missionDesc ? `<div class="mission-desc">${missionDesc}</div>` : ''}
                </div>`;
        });

        container.innerHTML = html;
    }

    // ‚îÄ‚îÄ Fetch launches ‚îÄ‚îÄ
    async function fetchLaunches() {
        try {
            const response = await fetch('/api/launches');

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            renderLaunches(data.results);

        } catch (error) {
            console.error('Failed to fetch launches:', error);
            document.getElementById('launches-container').innerHTML = `
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-message">Unable to load launch data</div>
                    <div class="error-hint">${error.message || 'Please try again later'}</div>
                </div>`;
        }
    }

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    fetchLaunches();

    // Refresh every 5 minutes
    setInterval(fetchLaunches, 5 * 60 * 1000);
</script>
